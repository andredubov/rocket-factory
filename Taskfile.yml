version: '3'

# Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
vars:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  BUF_VERSION: '1.53.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  OGEN_VERSION: 'v1.14.0'
  YQ_VERSION: 'v4.45.2'
  GRPCURL_VERSION: 'v1.9.3'
  MOCKERY_VERSION: 'v2.53.3'

  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  BUF: '{{.BIN_DIR}}/buf'
  OGEN: '{{.BIN_DIR}}/ogen'
  YQ: '{{.BIN_DIR}}/yq'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  GRPCURL: '{{.BIN_DIR}}/grpcurl'
  MOCKERY: "{{.BIN_DIR}}/mockery"

  NODE_MODULES_DIR: '{{.ROOT_DIR}}/node_modules/.bin'
  REDOCLY: '{{.NODE_MODULES_DIR}}/redocly'

  OPEN_API_ORDER_V1_BASE: '{{.ROOT_DIR}}/shared/api/order/v1/order.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: '{{.ROOT_DIR}}/shared/api/bundles/order.openapi.v1.bundle.yaml'

  OPEN_API_FILES: '{{.ROOT_DIR}}/shared/api/bundles'
  OPEN_API_TARGET: '{{.ROOT_DIR}}/shared/pkg/openapi/order/v1'
  OPEN_API_PACKAGE: 'order_v1'
  OPEN_API_FILE: '{{.OPEN_API_ORDER_V1_BASE}}'
  
  COVERAGE_DIR: '{{.ROOT_DIR}}/coverage'
  COVERAGE_FILE: total.out

  MODULES: inventory order payment

tasks:
  install-formatters:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€Ñ‹ gci Ð¸ gofumpt Ð² ./bin"
    summary: |
      Ð­Ñ‚Ð° Ð·Ð°Ð´Ð°Ñ‡Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð´Ð° gofumpt Ð¸ gci Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ bin.
      Ð•ÑÐ»Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, Ð¾Ð½Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð²ÐµÑ€ÑÐ¸ÑÐ¼Ð¸.
      
      Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ:
        - gofumpt: Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð´Ð° Go
        - gci: Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Go
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚ gofumpt + gci, Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ mocks"
    summary: |
      Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÐµ Go-Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ gofumpt Ð´Ð»Ñ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð´Ð°
      Ð¸ gci Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð², Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ… mocks.
      
      Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:
        - gofumpt: Ð´Ð»Ñ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        - gci: Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Ð¿Ð¾ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼
    deps: [ install-formatters ]
    cmds:
      - |
        echo "ðŸ§¼ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· gofumpt ..."
        
        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "ðŸ§¼ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
          fi
        done
      - |
        echo "ðŸŽ¯ Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· gci ..."
        
        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "ðŸŽ¯ Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð² $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix(github.com/andredubov/rocket-factory)" {} +
          fi
        done

  install-golangci-lint:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ golangci-lint Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ bin"
    summary: |
      ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ golangci-lint Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ bin.
      Ð•ÑÐ»Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ñ‡ÐµÑ€ÐµÐ· go install.
      
      Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:
    desc: "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ golangci-lint Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð»Ð¸Ð½Ñ‚ÐµÑ€ golangci-lint Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
      Ð›Ð¸Ð½Ñ‚ÐµÑ€ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÐºÐ¾Ð´ Ð½Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°Ð¼ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð¸ Ð»ÑƒÑ‡ÑˆÐ¸Ð¼ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°Ð¼.
      ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· gosec (Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Ð² golangci-lint).
      
      Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸:
        - install-golangci-lint: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð»Ð¸Ð½Ñ‚ÐµÑ€
        - format: Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ ÐºÐ¾Ð´ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹
    deps: [ install-golangci-lint ]
    vars:
      MODULES: '{{.MODULES}}'
      GOLANGCI_LINT: '{{.GOLANGCI_LINT}}'
    cmds:
      - |
        set -e
        ERR=0
        echo "ðŸ” Ð›Ð¸Ð½Ñ‚Ð¸Ð¼ Ð²ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "ðŸ” Ð›Ð¸Ð½Ñ‚Ð¸Ð¼ $mod module"
            {{.GOLANGCI_LINT}} run $mod/... --config=.golangci.yml || ERR=1
          fi
        done
        exit $ERR

  install-buf:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Buf Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ bin"
    cmds:
      - |
        [ -f {{.BUF}} ] || {
          mkdir -p {{.BIN_DIR}} tmp-buf
          curl -sSL \
            "https://github.com/bufbuild/buf/releases/download/v{{.BUF_VERSION}}/buf-$(uname -s)-$(uname -m).tar.gz" \
            | tar -xz -C tmp-buf
          mv tmp-buf/buf/bin/buf {{.BUF}}
          rm -rf tmp-buf
          chmod +x {{.BUF}}
        }

  proto:install-plugins:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ protoc Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ bin"
    cmds:
      - |
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'ðŸ“¦ Installing protoc-gen-go...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'ðŸ“¦ Installing protoc-gen-go-grpc...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        }

  proto:gen:
    deps: [ install-buf, proto:install-plugins, proto:lint ]
    desc: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Go-ÐºÐ¾Ð´Ð° Ð¸Ð· .proto
    dir: shared/proto
    cmds:
      - '{{.BUF}} generate'

  proto:lint:
    deps: [ install-buf, proto:install-plugins ]
    desc: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .proto-Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÑÑ‚Ð¸Ð»ÑŽ
    dir: shared/proto
    cmds:
      - '{{.BUF}} lint'

  redocly-cli:install:
    desc: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Redocly CLI
    cmds:
      - |
        [ -f {{.REDOCLY}} ] || {
          npm ci
        } || {
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ redocly-cli..."
          npm install
        }

  redocly-cli:order-v1-bundle:
    desc: Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ OpenAPI Ð² Ð¾Ð´Ð¸Ð½ Ñ„Ð°Ð¹Ð» Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ redocly
    deps: [ redocly-cli:install ]
    cmds:
      - '{{.REDOCLY}} bundle {{.OPEN_API_ORDER_V1_BASE}} -o {{.OPEN_API_ORDER_V1_BUNDLE}}'

  redocly-cli:bundle:
    desc: Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ ÑÑ…ÐµÐ¼Ñ‹ OpenAPI Ð² Ð¾Ð±Ñ‰Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ redocly
    deps: [ redocly-cli:install ]
    cmds:
      - task: redocly-cli:order-v1-bundle

  ogen:install:
    desc: "Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ ogen Ð² Ð¿Ð°Ð¿ÐºÑƒ bin"
    cmds:
      - |
        [ -f {{.OGEN}} ] || {
          mkdir -p {{.BIN_DIR}}
          GOBIN={{.BIN_DIR}} go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
        }

  ogen:gen:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Go-ÐºÐ¾Ð´Ð° Ð¸Ð· Ð²ÑÐµÑ… OpenAPI-Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ†Ð¸Ð¹ Ñ x-ogen"
    deps: [ ogen:install, yq:install ]
    cmds:
      - |
        {{.OGEN}} --target "{{.OPEN_API_TARGET}}" --package "{{.OPEN_API_PACKAGE}}" --clean "{{.OPEN_API_FILE}}" || exit 1

  gen:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… proto Ð¸ OpenAPI Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ†Ð¸Ð¹"
    cmds:
      - task: proto:gen
      - task: ogen:gen

  deps:update:
    desc: "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² go.mod Ð²Ð¾ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÑÑ…"
    cmds:
      - |
        echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² go.mod Ð²Ð¾ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÑÑ…"
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² $mod"
            (cd "$mod" && go mod tidy -compat=1.24) || exit 1
          fi
        done

  yq:install:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ yq Ð² bin/ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸"
    cmds:
      - |
        [ -f {{.YQ}} ] || {
          echo 'ðŸ“¦ Installing yq...'
          GOBIN={{.BIN_DIR}} go install github.com/mikefarah/yq/v4@{{.YQ_VERSION}}
        }

  grpcurl:install:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ grpcurl Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ bin"
    cmds:
      - |
        [ -f {{.GRPCURL}} ] || {
          echo 'ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ grpcurl {{.GRPCURL_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/fullstorydev/grpcurl/cmd/grpcurl@{{.GRPCURL_VERSION}}
        }
    status:
      - test -x {{.GRPCURL}}

  mockery:install:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ mockery Ð² ./bin"
    cmds:
      - |
        [ -f {{.MOCKERY}} ] || {
          echo 'ðŸ“¦ Installing mockery...'
          GOBIN={{.BIN_DIR}} go install github.com/vektra/mockery/v2@{{.MOCKERY_VERSION}}
        }
    status:
      - test -x {{.MOCKERY}}

  mockery:gen:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¼Ð¾ÐºÐ¸ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ mockery"
    deps: [ mockery:install ]
    cmds:
      - |
        echo 'ðŸ§ª Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¼Ð¾ÐºÐ¾Ð²...'
        {{.MOCKERY}}

  test-coverage:
    desc: "Ð¢ÐµÑÑ‚Ñ‹ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ¸ (service/repository), Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð¼Ð¾Ð´ÑƒÐ»ÑŽ + Ð¾Ð±Ñ‰Ð¸Ð¹"
    cmds:
      - |
        echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ..."
        rm -rf {{.COVERAGE_DIR}}
        mkdir -p {{.COVERAGE_DIR}}
        
        ERR=0
        for mod in {{.MODULES}}; do
          echo "ðŸ“¦ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ: $mod"
        
          TARGET_PKGS=$(go list ./$mod/... \
            | grep -E '/(internal/(service|repository))' \
            | grep -vE '/(mocks|testdata|pkg|api|proto|pb|cmd)' \
            | paste -sd "," -)
        
          if [ -z "$TARGET_PKGS" ]; then
            echo "âš ï¸  ÐÐµÑ‚ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð² $mod"
            continue
          fi
        
          go test -coverpkg="$TARGET_PKGS" \
            -coverprofile={{.COVERAGE_DIR}}/$mod.out \
            -covermode=atomic \
            $(echo "$TARGET_PKGS" | tr "," " ") || ERR=1
        done
        
        if [ $ERR -ne 0 ]; then
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²"
          exit $ERR
        fi
        
        echo
        echo "ðŸ“Š ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð¼Ð¾Ð´ÑƒÐ»ÑŽ:"
        for mod in {{.MODULES}}; do
          OUTFILE="{{.COVERAGE_DIR}}/$mod.out"
          if [ -f "$OUTFILE" ]; then
            printf " â€¢ %s: " "$mod"
            go tool cover -func="$OUTFILE" | tail -n1
          fi
        done
        
        echo
        echo "ðŸ“¦ Ð¡ÐºÐ»ÐµÐ¸Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ..."
        {
          echo "mode: atomic"
          find {{.COVERAGE_DIR}} -type f -name '*.out' ! -name '{{.COVERAGE_FILE}}' \
            -exec grep -h -v "^mode:" {} +
        } > {{.COVERAGE_DIR}}/{{.COVERAGE_FILE}}
        
        echo
        echo "ðŸ§¾ ÐžÐ±Ñ‰ÐµÐµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾ Ð²ÑÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼:"
        go tool cover -func={{.COVERAGE_DIR}}/{{.COVERAGE_FILE}} | tail -n1

  coverage:html:
    desc: "Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
    deps: [ test-coverage ]
    cmds:
      - |
        OUTPUT={{.COVERAGE_DIR}}/coverage.html
        echo "ðŸŒ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚..."
        go tool cover -html={{.COVERAGE_DIR}}/{{.COVERAGE_FILE}} -o $OUTPUT

        echo "ðŸš€ ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ $OUTPUT"
        
        # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð´Ð»Ñ macOS
        if command -v open &> /dev/null; then
          open $OUTPUT 2>/dev/null && exit 0
        fi
        
        # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð´Ð»Ñ Linux Ñ xdg-open
        if command -v xdg-open &> /dev/null; then
          xdg-open $OUTPUT 2>/dev/null && exit 0
        fi
        
        # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½Ð°Ð¹Ñ‚Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ñ‹
        BROWSERS=(
          firefox
          google-chrome
          chromium
          chromium-browser
          microsoft-edge
          opera
        )
        
        for browser in "${BROWSERS[@]}"; do
          if command -v $browser &> /dev/null; then
            $browser $OUTPUT 2>/dev/null && exit 0
          fi
        done
        
        # Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð»Ð¾
        echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
        echo "ðŸ“‚ ÐžÑ‚Ñ‡Ñ‘Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð²: $OUTPUT"
        echo "   Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ð¸ Ð¾Ñ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð² Ð»ÑŽÐ±Ð¾Ð¼ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ:"
        echo "   file://$OUTPUT"
        exit 0

  test:
    desc: "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑŽÐ½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑŽÐ½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
      ÐœÐ¾Ð¶Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ MODULES.
    cmds:
      - |
        ERR=0
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ $mod"
            go test -v ./$mod/... || ERR=1
          fi
        done
        exit $ERR

  test-api:
    desc: "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ API Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²"
    deps: [ grpcurl:install ]
    cmds:
      - |
        echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ API Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· gRPC Ð¸ REST"
        
        echo "ðŸ“¦ Ð¢ÐµÑÑ‚ 1: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ Ð¸Ð· Inventory"
        PARTS_RESPONSE=$({{.GRPCURL}} -plaintext -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts)
        
        if [[ -z "$PARTS_RESPONSE" || "$PARTS_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $PARTS_RESPONSE"
          exit 1
        fi
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ UUID Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐ¸Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²
        PART_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -1 | cut -d'"' -f4)
        if [ -z "$PART_UUID" ]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ð¹Ñ‚Ð¸ UUID Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $PARTS_RESPONSE"
          exit 1
        fi
        echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹, Ð¿ÐµÑ€Ð²Ð°Ñ UUID: $PART_UUID"
        
        echo
        echo "ðŸ” Ð¢ÐµÑÑ‚ 2: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾ UUID"
        PART_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"uuid\":\"$PART_UUID\"}" localhost:50051 inventory.v1.InventoryService/GetPart)
        
        if [[ -z "$PART_RESPONSE" || "$PART_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´ÐµÑ‚Ð°Ð»Ð¸."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $PART_RESPONSE"
          exit 1
        fi
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸Ð¼Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸ 
        PART_NAME=$(echo $PART_RESPONSE | grep -o '"name": "[^"]*' | cut -d'"' -f4)
        if [ -z "$PART_NAME" ]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸Ð¼Ñ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $PART_RESPONSE"
          exit 1
        fi
        echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð° Ð´ÐµÑ‚Ð°Ð»ÑŒ: $PART_NAME"
        
        echo
        echo "ðŸ‘¤ Ð¢ÐµÑÑ‚ 3: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²"
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ UUID Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        USER_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
        echo "âœ… Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ UUID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: $USER_UUID"
        
        echo
        echo "ðŸ“ Ð¢ÐµÑÑ‚ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (REST API)"
        ORDER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")
        
        if [[ -z "$ORDER_RESPONSE" || "$ORDER_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER_RESPONSE"
          exit 1
        fi
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ UUID Ð·Ð°ÐºÐ°Ð·Ð° Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² JSON
        ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_UUID" ]; then
          ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_UUID" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ UUID Ð·Ð°ÐºÐ°Ð·Ð° Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°."
            echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER_RESPONSE"
            exit 1
          fi
        fi
        echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½ Ð·Ð°ÐºÐ°Ð· Ñ UUID: $ORDER_UUID"
        
        echo
        echo "ðŸ“Š Ð¢ÐµÑÑ‚ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð·Ð°ÐºÐ°Ð·Ð° (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ PENDING_PAYMENT)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID")
        
        if [[ -z "$ORDER_INFO_RESPONSE" || "$ORDER_INFO_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð·Ð°ÐºÐ°Ð·Ðµ."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER_INFO_RESPONSE"
          exit 1
        fi
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð° Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² JSON
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_STATUS" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð° Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°."
            echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER_INFO_RESPONSE"
            exit 1
          fi
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ PENDING_PAYMENT
        if [[ "$ORDER_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð°. ÐžÐ¶Ð¸Ð´Ð°Ð»ÑÑ PENDING_PAYMENT, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: $ORDER_STATUS"
          exit 1
        fi
        echo "âœ… ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹: $ORDER_STATUS"
        
        echo
        echo "ðŸ’° Ð¢ÐµÑÑ‚ 6: ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð·Ð°ÐºÐ°Ð·Ð° (REST API)"
        PAY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER_UUID/pay" \
          -H "Content-Type: application/json" \
          -d "{\"payment_method\":\"PAYMENT_METHOD_CARD\"}")
        
        if [[ "$PAY_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ðµ Ð·Ð°ÐºÐ°Ð·Ð°."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $PAY_RESPONSE"
          exit 1
        fi
        echo "âœ… Ð—Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½"
        
        echo
        echo "ðŸ“Š Ð¢ÐµÑÑ‚ 7: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ PAID)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID")
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð°
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÑ‚Ð°Ð» PAID
        if [[ "$ORDER_STATUS" != *"PAID"* && "$ORDER_STATUS" != *"ASSEMBLED"* ]]; then
          echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹. ÐžÐ¶Ð¸Ð´Ð°Ð»ÑÑ PAID Ð¸Ð»Ð¸ ASSEMBLED, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: $ORDER_STATUS"
          exit 1
        fi
        echo "âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð·Ð°ÐºÐ°Ð·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹: $ORDER_STATUS"
        
        echo
        echo "ðŸ“ Ð¢ÐµÑÑ‚ 8: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ (REST API)"
        ORDER2_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")
        
        if [[ -z "$ORDER2_RESPONSE" || "$ORDER2_RESPONSE" == *"error"* ]]; then
          echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð·Ð°ÐºÐ°Ð·."
          echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER2_RESPONSE"
          exit 1
        fi
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ UUID Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² JSON
        ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_UUID" ]; then
          ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER2_UUID" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ UUID Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°."
            echo "ðŸ” ÐžÑ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°: $ORDER2_RESPONSE"
            exit 1
          fi
        fi
        echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð·Ð°ÐºÐ°Ð· Ñ UUID: $ORDER2_UUID"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÐ³Ð¾ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°. ÐžÐ¶Ð¸Ð´Ð°Ð»ÑÑ PENDING_PAYMENT, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: $ORDER2_STATUS"
          exit 1
        fi
        echo "âœ… ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°: $ORDER2_STATUS"
        
        echo
        echo "âŒ Ð¢ÐµÑÑ‚ 9: ÐžÑ‚Ð¼ÐµÐ½Ð° Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° (REST API)"
        echo "ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¼ÐµÐ½Ð¾Ð¹..."
        sleep 2
        
        curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER2_UUID/cancel"
        
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹..."
        
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"CANCELLED"* ]]; then
          echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°. ÐžÐ¶Ð¸Ð´Ð°Ð»ÑÑ CANCELLED, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: $ORDER2_STATUS"
          echo "ðŸ” Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°: $ORDER2_INFO"
          exit 1
        fi
        echo "âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹: $ORDER2_STATUS"
        
        echo
        echo "ðŸŽ‰ Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ API ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹!"

  run:inventory:
    cmds:
      - go build -o ./bin/inventory ./inventory/cmd/main.go
      - ./bin/inventory -config-path ./inventory/config/.env

  run:payment:
    cmds:
      - go build -o ./bin/payment ./payment/cmd/main.go
      - ./bin/payment -config-path ./payment/config/.env

  run:order:
    cmds:
      - go build -o ./bin/order ./order/cmd/main.go
      - ./bin/order -config-path ./order/config/.env

  docker-compose:generate-env:
    desc: "Generate root .env file from service configs"
    deps: [docker-compose:check-env-files]
    cmds:
      - |
        echo "Generating {{.ENV_FILE}}..."
        echo "INVENTORY_GRPC_HOST=$(grep 'GRPC_HOST=' ./inventory/config/.env | cut -d '=' -f2)" > {{.ENV_FILE}}
        echo "INVENTORY_GRPC_PORT=$(grep 'GRPC_PORT=' ./inventory/config/.env | cut -d '=' -f2)" >> {{.ENV_FILE}}
        echo "PAYMENT_GRPC_HOST=$(grep 'GRPC_HOST=' ./payment/config/.env | cut -d '=' -f2)" >> {{.ENV_FILE}}
        echo "PAYMENT_GRPC_PORT=$(grep 'GRPC_PORT=' ./payment/config/.env | cut -d '=' -f2)" >> {{.ENV_FILE}}
        echo "File {{.ENV_FILE}} created successfully!"
    silent: false
    vars:
      ENV_FILE: .env

  docker-compose:check-env-files:
    desc: "Verify required .env files exist"
    cmds:
      - |
        test -f ./inventory/config/.env || (echo "Error: ./inventory/config/.env not found" && exit 1)
        test -f ./payment/config/.env || (echo "Error: ./payment/config/.env not found" && exit 1)
    silent: true

  docker-compose:local:down:
    cmds:
      - task: docker-compose:check-env-files
      - task: docker-compose:generate-env
      - docker compose --env-file .env down --remove-orphans 
      - rm .env

  docker-compose:local:up:
    cmds:
      - task: docker-compose:check-env-files
      - task: docker-compose:generate-env
      - docker compose --env-file .env up --build -d
      - rm .env
